name: sample

var:
  jsontestEndpoint: "http://echo.jsontest.com/"
  jsonValue: "value"

ctx:
  shell:
    type: shell
  jsontest:
    type: http
    args:
      "#endpoint": "var.jsontestEndpoint"
    dft:
      req:
        method: GET
      retry:
        attempts: 3
        delay: 5s
      until:
        attempts: 3
        delay: 5s

setUp:
  - name: EchoHelloWorld
    step:
      - ctx: shell
        req:
          command: "echo hello world"
        res:
          exitCode: 0

tearDown:
  - name: GoodBye
    step:
      - ctx: shell
        req:
          command: "echo good bye"

beforeCase:
  - ctx: shell
    req:
      command: "echo before case"

afterCase:
  - ctx: shell
    req:
      command: "echo after case"

case:
  - name: TestHttpJson
    label:
      key: val
    cond: "var.jsonValue == 'value'"
    step:
      - ctx: jsontest
        req:
          "#path": "'/key/{}/one/two'.format(var.jsonValue)"
        retry:
          cond: "step.res['status'] == 500"
          attempts: 2
          delay: 1s
        until:
          cond: "step.res['status'] == 200"
        res:
          status: 200
          headers: {
            "Access-Control-Allow-Origin": "*",
            "Content-Type": "application/json",
            "#X-Cloud-Trace-Context": "len(val) == 32"
          }
          json: {
            "one": "two",
            "#key": "var.jsonValue"
          }
