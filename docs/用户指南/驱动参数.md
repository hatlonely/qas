# 驱动参数

## shell

shell 可以用来执行命令和脚本

### 启动参数

- `shebang`: `string`，执行程序，默认 `/bin/bash`
- `args`: `[string]`，程序启动参数，默认 `["-c"]`

```yaml
ctx:
  sh:
    type: shell
    dft:
      req:
        envs:
          SH_CTX_ENV_KEY: sh-ctx-env-val
  py:
    type: shell
    args:
      shebang: /usr/local/bin/python3
      args:
        - -c
```

### 执行命令

**请求**

- `command`: `string`，执行命令，必填
- `envs`: `[string, string]`，程序执行环境变量，默认为空
- `decoder`: `string`，解码规则，将结果按某种规则解析成对象，方便后面的结果校验和引用，可选值 `text/json/yaml`，默认 `text`

**返回**

- `exitCode`: 状态返回码
- `stdout`: 标准输出
- `stderr`: 标准错误
- `json`: 如果设置了 decoder，并且格式正确，会将结果转换成对象
- `err`: 如果设置了 decoder，捕获解析失败的异常

```yaml
case:
  - name: ShellExample
    step:
      - ctx: sh
        req:
          command: |
            echo SH_CTX_ENV_KEY=${SH_CTX_ENV_KEY}
            echo CASE_ENV_KYE=${CASE_ENV_KYE}
          envs:
            CASE_ENV_KYE: case-env-val
        res:
          exitCode: 0
          stdout: |
            SH_CTX_ENV_KEY=sh-ctx-env-val
            CASE_ENV_KYE=case-env-val
      - ctx: py
        req:
          command: |
            import json
            print(json.dumps({"key1": "val1", "key2": "val2"}))
          decoder: json
        res:
          exitCode: 0
          stdout: |
              {"key1": "val1", "key2": "val2"}
          stderr: ""
          json:
            key1: val1
            key2: val2
```

## http

http client

### 启动参数

- `endpoint`: `string`，url 地址，必填，例如：`http://echo.jsontest.com/`

```yaml
ctx:
  jsontest:
    type: http
    args:
      endpoint: http://echo.jsontest.com
```

### 发起请求

**请求**

- `endpoint`: `string`，url 地址，默认使用启动参数中的 endpoint
- `path`: `string`，url path，默认为空
- `method`: `string`，http 方法，默认 POST
- `headers`: `[string, string]`，请求头部，默认为空
- `params`: `[string, string]`，query 参数，默认为空
- `data`: `string`，请求 body，默认为空
- `json`: `any`，json body，默认为空
- `timeout`: `string`，超时时间，默认 1s
- `allowRedirects`: `bool`，是否允许重定向，默认为 true


**返回**

- `status`: `int`，返回 http 状态码
- `headers`: `[string, string]`，返回头部
- `text`: `string`，返回 body
- `json`: `any`，按 json 格式解析 body

```yaml
case:
  - name: HttpExample
    step:
      - ctx: jsontest
        req:
          path: /key/value/one/two
          timeout: 10s
        res:
          status: 200
          headers: {
            "Access-Control-Allow-Origin": "*",
            "Content-Type": "application/json",
            "#X-Cloud-Trace-Context": "len(val) == 32"
          }
          json: {
            "one": "two",
            "key": "value"
          }
```

## mysql

mysql client

### 启动参数

- `host`: `string`，主机地址，默认 localhost
- `port`: `int`，主机端口，默认 3306
- `username`: `string`，用户名，必填
- `password`: `string`，密码，必填
- `database`: `string`，数据库名，必填

```yaml
ctx:
  db:
    type: mysql
    args:
      host: "localhost"
      port: 3306
      username: "hatlonely"
      password: "keaiduo1"
      database: "hatlonely"
```

### 执行 sql

**请求**

- `cmd`: `string`，执行 sql 后调用命令，默认 `sql`，可选值 `sql/fetchone/fetchall`
    - `sql`: 仅执行 sql
    - `fetchone`: 执行 sql 后获取一条结果
    - `fetchall`: 执行 sql 后获取所有结果
- `sql`: `string`，sql，支持 `%s` 表示位置参数，必填
- `args`: `[string]`，sql 中的位置参数，默认为空

**返回**

- `code`: `string`，执行结果，成功返回 `OK`
    - `OK`: 成功
    - `OperationalError`: 操作类错误
- `res`: `[string, any]`，查询结果
- `err`: `[string, any]`，错误结果
    - `type`: `string`，错误类型，目前仅有一种 `OperationalError`
    - `args`: `[string]`，错误返回结果

```yaml
case:
  - name: MysqlExample
    step:
      - ctx: db
        req:
          sql: |
            INSERT INTO `users` (`email`, `password`) VALUES (%s, %s), (%s, %s)
          args:
            - "hatlonely@foxmail.com"
            - "123456"
            - "playjokes@foxmail.com"
            - "456789"
        res:
          code: OK
      - ctx: db
        req:
          cmd: fetchone
          sql: |
            SELECT `id`, `password` FROM `users` WHERE `email`=%s
          args:
            - "hatlonely@foxmail.com"
        res:
          code: OK
          res:
            password: "123456"
      - ctx: db
        req:
          cmd: fetchall
          sql: |
            SELECT * FROM `users` WHERE 1=1
        res:
          code: OK
          res: [{
            "id": 1,
            "email": "hatlonely@foxmail.com",
            "password": "123456"
          }, {
            "id": 2,
            "email": "playjokes@foxmail.com",
            "password": "456789"
          }]
```
